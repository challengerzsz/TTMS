<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>售票员卖票</title>
    <link rel="stylesheet" type="text/css" href="css/sale.css" />
    <link rel="stylesheet" type="text/css" href="css/common.css" />
</head>
<body>
<div id="nav">
    <img src="image/小仙女.png"  alt="图标"  width="200px" id="tuBiao"/>
    <ul>
        <li>
            <a href="index.html"><p>首页</p></a>
        </li>
        <li>
            <a href=""><p>电影</p></a>
        </li>
        <li>
            <a href=""><p>影院</p></a>
        </li>
        <li>
            <a href="ranking.html"><p>榜单</p></a>
        </li>
        <li>
            <a href="person.html" id="link"><p>个人中心</p></a>
        </li>
    </ul>
</div>
<div id="box">
    <div class="conten">
        <div class="list">
            <span><img src="image/white.png" align="middle" width="30px"> 可选座位</span>
            <span><img src="image/red.png" align="middle" width="30px"> 已售座位</span>
            <span><img src="image/green.png" align="middle" width="30px"> 已选座位</span>
            <span><img src="image/love_people.png" align="middle" width="50px"> 情侣座位</span>
        </div>
        <div class="screen">
            <img src="image/screen.png">
            <br>
            <span>荧幕中央</span>
        </div>
        <div class="obody">
            <div id="seat">
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
                <img src="image/white.png" alt="座位" />
            </div>
            <ul>
                <li>1</li>
                <li>2</li>
                <li>3</li>
                <li>4</li>
                <li>5</li>
                <li>6</li>
                <li>7</li>
                <li>8</li>
                <li>9</li>
            </ul>
        </div>
    </div>

    <div class="about">
        <div class="more">
            <div class="pic">
                <img src="image/union.png" width="120px" id="img">
            </div>
            <div class="topic">
                <h3 id="movieName"></h3>
                <div class="text">
                    <span>类型：</span><span id="type"></span>
                    <br>
                    <span>时长：</span><span id="dur"></span>分钟
                </div>
            </div>
        </div>
        <div class="explain">
            <br />

            <span>影院：</span>万达国际影院
            <br />
            <span>影厅：</span><span id="hall"></span>号激光厅
            <br />
            <span>场次：</span><span class="time" id="time"></span>
            <br />
            <span>票价：</span>¥ <span id="money"></span>/张
        </div>
        <div class="price">
            <span>座位：</span>请<span class="time">点击左侧</span>座位图选择座位
            <div id="message">

            </div>
            <div class="sum" >
                <p>票数：<span id="num">0</span></p>
                <!--<p>总价：<span class="red">¥<span id="total">0</span></span> </p>-->
            </div>
        </div>
        <input type="submit" name="buy" value="确认购买" id="buy"  @click="buy();"/>
    </div>
</div>

<!--  页尾 -->
<div style="clear:both;"></div>
<div id="footer">
    <p>违法和不良信息举报电话: 4006018900 举报邮箱: jubao.maoyan@maoyan.com</p>
    <p>友情链接 : <span>美团网</span>  <span>美团下载</span></p>
    <p>©2016 猫眼电影 maoyan.com 京ICP证160733号 京ICP备16022489号-1 京公网安备 11010502030881号 网络文化经营许可证 电子公告服务规则<p>
    <p>北京猫眼文化传媒有限公司</p>
</div>
</body>
</html>
<script type="text/javascript">
    window.onload=function(){

        //这里显示的是其中选的座位的数量
        var num=0;
        // var price = parseInt(document.getElementById("money").innerHTML);
        // var total = document.getElementById("total");
        var message = document.getElementById("message");
        var number = document.getElementById("num");
        var buy = document.getElementById("buy");

        // //这里是显得是对应的其中的修改其中的修改状态的
        var seat = document.getElementById('seat').getElementsByTagName('img');
        for (var i = seat.length - 1; i >= 0; i--) {
            seat[i].seatBtn=true;
            seat[i].buy=false;
        }


        //这里是其中的演出计划的id的
        var scheduleId =parseInt(getParam("scheduleId"));

        var movieId =  getParam("movieId");
        //这里是进行座位的初始化
        beginning();
        show();
        showPrice();






        //这里实现的就是其中的传递数据的

        buy.onclick=function(){
            var information = message.getElementsByTagName("p");
            var data=[];
            for (var i = information.length - 1; i >= 0; i--)
            {
                var text = information[i].innerHTML;
                var col;
                if(text.length==5){
                    col = text.substring(2,4);
                }
                else{
                    col = text.substring(2,3);
                }
                var row = text.substring(0,1);

                var seatInformation ={
                    "scheduleId":scheduleId,
                    "row":row,
                    "column":col
                }

                data.push(seatInformation);

            }
            var seatInformation = {
                "seats":data
            }
            loadXMLDoc(seatInformation);
        }


        var link = document.getElementById("link");
        var id = getParam("id");
        link.setAttribute("href","person.html?id="+id);

        //获取其中的url里面的值的
        function  getParam(name) {
            var search = document.location.search;
            //alert(search);
            var pattern = new RegExp("[?&]" + name + "\=([^&]+)", "g");
            var matcher = pattern.exec(search);
            var items = null;
            if (null != matcher) {
                try {
                    items = decodeURIComponent(decodeURIComponent(matcher[1]));
                } catch (e) {
                    try {
                        items = decodeURIComponent(matcher[1]);
                    } catch (e) {
                        items = matcher[1];
                    }
                }
            }
            return items;
        };



        function beginning()
        {
            var xmlhttp;
            if (window.XMLHttpRequest)   xmlhttp=new XMLHttpRequest();
            else                        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            xmlhttp.onreadystatechange = function()
            {
                if (xmlhttp.readyState==4 && xmlhttp.status==200)
                {
                    var seat = document.getElementById('seat').getElementsByTagName('img');
                    var data=JSON.parse(xmlhttp.responseText);
                    if(data.status=="1")
                    {
                        var message = data.data;
                        for(var i = 0; i <=message.length - 1; i++) {
                            var row = message[i].seatRow;
                            var cols = message[i].seatColumn;
                            var number = (parseInt(row)-1)*10+parseInt(cols-1);
                            var seat = document.getElementById("seat").getElementsByTagName("img");
                            seat[number].setAttribute("src","image/red.png");
                            seat[number].buy=true;
                        }
                    }
                    else{
                        alert("目前还没有人买票");
                    }
                }
            }
            xmlhttp.open("GET","/TTMS/ticket/"+scheduleId,true);
            xmlhttp.send(null);
        }




        //这个是对应的增加其中的信息
        function inform(i,parent){
            var row;
            var col = i%10;
            if(col==0){
                col=10;
                row=(parseInt(i/10))
            }
            else{
                col = i%10;
                row=(parseInt(i/10))+1;
            }
            var p = document.createElement('p');
            p.innerHTML=row+"排"+col+"座";
            p.style.float="left";
            p.style.margin="10px";
            p.style.backgroundColor ="gray";
            p.style.padding="5px";
            p.style.borderRadius="5px";
            parent.appendChild(p);
        }



        //这里实现的其中的删除的信息
        function deleteMessage(i,parent)
        {
            var row;
            var col = i%10;
            if(col==0){
                col=10;
                row=(parseInt(i/10));
            }
            else{
                col = i%10;
                row=(parseInt(i/10))+1;
            }
            var information = parent.getElementsByTagName("p");
            for (var i = information.length - 1; i > -1; i--) {
                var text = information[i].innerHTML;
                var col1;
                if(text.length==5){
                    col1 = text.substring(2,4);
                }
                else{
                    col1 = text.substring(2,3);
                }
                var row1 = text.substring(0,1);
                if(row==row1 && col==col1){
                    parent.removeChild(information[i]);
                }
            }

        }

        function communication(){
            for (var i = 0; i <=seat.length - 1; i++) {
                seat[i].index=i;
                seat[i].onclick=function(){
                    if(this.seatBtn  && this.buy==false){
                        this.setAttribute('src','image/green.png');
                        if(num==6){
                            alert("您最多只能买6张");
                            this.setAttribute('src','image/white.png');
                            // total.innerHTML=6*price;
                            return ;
                        }
                        num++;
                        this.seatBtn=false;
                        inform(this.index+1,message);
                    }
                    else if(this.buy==true){
                        alert("这张票已经售出");
                    }
                    else if(!this.seatBtn){
                        deleteMessage(this.index+1,message);
                        num--;
                        this.setAttribute('src','image/white.png');
                        this.seatBtn=true;
                    }
                    // total.innerHTML=num*price;
                    number.innerHTML=num;
                }
            }
        }


        //这里实现的是其中的传递数据的
        function loadXMLDoc(obj)
        {
            var xmlhttp;
            if (window.XMLHttpRequest)   xmlhttp=new XMLHttpRequest();
            else                         xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            xmlhttp.onreadystatechange=function()
            {
                if (xmlhttp.readyState==4 && xmlhttp.status==200)
                {
                    console.log(xmlhttp.responseText);
                    var message = JSON.parse(xmlhttp.responseText);
                    if(message.status=="0")
                    {
                        window.open("login.html","_self");
                    }
                    else if(message.status=="1")
                    {
                        alert("购票成功");
                    }
                    else  if(message.status=="3")
                    {
                        alert("选座已被售");
                    }
                }
            }
            xmlhttp.open("POST","/TTMS/ticket/sell",true);
            xmlhttp.setRequestHeader("Content-type","application/json");
            xmlhttp.send(JSON.stringify(obj));
        }




//这里实现的是其中的电影的信息的展示

        function show()
        {
            var xmlhttp;
            if (window.XMLHttpRequest)  xmlhttp=new XMLHttpRequest();
            else                        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            xmlhttp.onreadystatechange=function()
            {
                if (xmlhttp.readyState==4 && xmlhttp.status==200)
                {
                    var message = JSON.parse(xmlhttp.responseText);
                    if(message.status=="1"){
                        var trueMessage=message.data;
                        var img = document.getElementById("img");
                        img.setAttribute("src",trueMessage.img);
                        var name = document.getElementById("movieName");
                        name.innerHTML=trueMessage.nm;
                        var type = document.getElementById("type");
                        type.innerHTML=trueMessage.cat;
                        var dur = document.getElementById('dur');
                        dur.innerHTML=trueMessage.dur;
                        var hall = document.getElementById("hall");
                        hall.innerHTML=trueMessage.preSale;
                        var time = document.getElementById("time");
                        time.innerHTML = trueMessage.showInfo;
                        showPrice();
                    }
                    else{
                        alert("后台还没有添加对应的影片信息");
                    }


                }
            }
            xmlhttp.open("GET","/TTMS/movies/"+getParam("movieId"),true);
            xmlhttp.send();
        }



//展示其中的价格的

        function showPrice()
        {
            var xmlhttp;
            if (window.XMLHttpRequest)  xmlhttp=new XMLHttpRequest();
            else                        xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
            xmlhttp.onreadystatechange=function()
            {
                if (xmlhttp.readyState==4 && xmlhttp.status==200)
                {
                    var message = JSON.parse(xmlhttp.responseText);
                    if(message.status=="1"){
                        var price = document.getElementById("money");
                        price.innerHTML=message.data.price;
                        communication();
                    }
                    else{
                        alert("出错啦!");
                    }


                }
            }
            xmlhttp.open("GET","/TTMS/schedule/getSchedule/"+scheduleId,true);
            xmlhttp.send();
        }


    };







</script>